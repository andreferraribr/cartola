---
title: "Cartola"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    runtime: shiny
    social: ["twitter", "facebook", "menu"]
---

```{r setup, include=FALSE}
library(flexdashboard)
library(dplyr)
library(readxl)
library(ggplot2)
library(stringr)
library(plotly)
library(ggrepel)
library(DT)
library (rpivotTable)
library(flexdashboard)
library(openintro)
library(highcharter)
library(knitr)
library(shiny)
```



```{r}
clubes <- read_excel("clubes.xlsx")


clubes<- clubes%>%
  mutate (despesa = receita - resultado)%>%
  mutate (absoluto = abs(resultado))%>%
  mutate (tag = if_else(rank(-absoluto) > 5,   "", clube)  )%>%
  mutate (grupo = "cbf")%>%
  mutate(forma = 19)

gov <- read_excel("org.xlsx")

colnames(gov)<- c("poder_cod","poder","org_max_cod","org_max","org_sup_cod","org_sup", "org_cod","org","uf","uf_nome","muni_cod","muni","ug_cod","ug","despesa","receita","resultado")

gov<-gov%>% mutate (grupo = "gov")%>%
  mutate(forma = 2 )%>%
  mutate (absoluto = abs(resultado))

gov$receita <- round(gov$receita/1000000,1)
gov$despesa <- round(gov$despesa/1000000,1)
gov$resultado <- round(gov$resultado/1000000,1)



clube_join<- clubes%>%
  select(clube, uf,receita, despesa, resultado, absoluto, tag, grupo, forma)%>%
  mutate(tam = absoluto/10)


colnames(clube_join)[1]<-"nome" 


gov_join<- gov%>%
  select(ug_cod,uf,receita, despesa, resultado, absoluto, org, forma)%>%
  mutate(tam = 1)%>%
  mutate (tag = if_else(rank(-absoluto) > 5,   "", ug_cod)  )

colnames(gov_join)[1]<-"nome" 


cartola<- full_join(gov_join, clube_join)



```

Selecione o perÃ­odo {.sidebar}
========================


###### Valor da despesa

```{r}
selectizeInput("nome", "nome", unique (gov_join$nome), selected = "170166", multiple = FALSE,
               options = NULL)
```




UG x Clubes
========================

Column {data-width=650}
-----------------------------------------------------------------------

### Chart A

```{r}


renderPlotly({

  
gov_join_s <- gov_join %>% filter(nome == input$nome)
  
cartola_s<- full_join(gov_join_s, clube_join)


  
lims_cartola <- c(0, max(c(max(cartola_s$despesa),max(cartola_s$receita))))

p_cartola <-   ggplot (cartola_s) +
  geom_point(aes ( shape = forma, x = despesa, y = receita, color = resultado,size = tam, label = nome))+
  geom_text(aes ( x = despesa, y = receita, label = nome))+
  scale_color_gradient2(midpoint=0, low="red", mid="gray",
                     high="blue", space ="Lab" )+
    scale_shape_identity()+
    geom_abline() +
    scale_x_continuous("Despesa", limits = lims_cartola ) +
    scale_y_continuous("Receita", limits = lims_cartola )

 
  
(p_cartola <- ggplotly(p_cartola) )

})

 

```







### Tabela


```{r}

renderDT({

gov_join_s <- gov_join %>% filter(nome == input$nome)
  
cartola_s<- full_join(gov_join_s, clube_join)

datatable(cartola_s%>%  select(nome,grupo, uf, receita, despesa, resultado),
          filter = 'top', options = list(  pageLength = 25, autoWidth = TRUE, style = "default", width = 1200))
})
```



Ranking
========================


```{r}
renderDT({


  


datatable(cartola%>%  select(nome,grupo, uf, receita, despesa, resultado),
          filter = 'top', options = list(  pageLength = 25, autoWidth = TRUE, style = "default", width = 1200))
})
```

